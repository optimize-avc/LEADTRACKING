name: Deploy to Firebase App Hosting

# ============================================================================
# DISABLED - Firebase App Hosting deploys automatically via Cloud Build
# ============================================================================
# Firebase App Hosting watches the main branch and triggers Cloud Build
# automatically on every push. This workflow is kept for manual deployments
# only via workflow_dispatch.
#
# Note: The FirebaseExtended/action-hosting-deploy action is for Firebase
# Hosting (static sites), NOT Firebase App Hosting (full-stack Next.js).
# ============================================================================

on:
    workflow_dispatch:
    # push:
    #     branches: [main]

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: false

jobs:
    deploy:
        name: Deploy to Production
        runs-on: ubuntu-latest
        environment: production
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci --legacy-peer-deps

            - name: Build Next.js app
              run: npm run build
              env:
                  NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
                  NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
                  NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
                  NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
                  NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
                  NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
                  service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

            - name: Deploy to Firebase App Hosting
              uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: ${{ secrets.GITHUB_TOKEN }}
                  firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
                  channelId: live
                  projectId: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}

            - name: Notify on success
              if: success()
              run: echo "âœ… Deployment successful!"
